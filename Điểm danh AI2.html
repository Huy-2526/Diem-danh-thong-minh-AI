<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªÜ TH·ªêNG ƒêI·ªÇM DANH TH√îNG MINH AI</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #0984e3; --accent: #00cec9; --bg: #0f172a; --success: #00b894; --warning: #f1c40f; --danger: #d63031; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; }
        
        #loading { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--accent); }
        .loader { width: 50px; height: 50px; border: 4px solid #333; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        header { background: rgba(30, 41, 59, 0.8); width: 100%; padding: 20px 0; text-align: center; border-bottom: 2px solid var(--primary); }
        header h2 { margin: 0; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; }

        #webcam-wrapper { position: relative; width: 90%; max-width: 640px; aspect-ratio: 4/3; margin-top: 20px; border-radius: 15px; overflow: hidden; border: 3px solid #334155; box-shadow: 0 0 30px rgba(9, 132, 227, 0.3); }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; }

        .status-box { width: 90%; max-width: 640px; margin-top: 15px; padding: 15px; background: #1e293b; border-radius: 10px; text-align: center; border: 1px solid #334155; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        #status-msg { font-weight: bold; font-size: 1.1rem; transition: 0.3s; }

        .panel { width: 90%; max-width: 640px; margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        
        .view { display: none; width: 100%; flex-direction: column; align-items: center; }
        .view.active { display: flex; }
        
        .reg-form { width: 90%; background: #1e293b; padding: 20px; border-radius: 15px; margin-top: 10px; box-sizing: border-box; }
        input { padding: 12px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="loader"></div>
        <p>ƒêANG KH·ªûI T·∫†O H·ªÜ TH·ªêNG ƒêI·ªÇM DANH AI...</p>
    </div>

    <header>
        <h2>H·ªÜ TH·ªêNG ƒêI·ªÇM DANH TH√îNG MINH AI</h2>
    </header>

    <div id="webcam-wrapper">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    <div class="status-box">
        <div id="status-msg" style="color: var(--warning);">ƒêANG CH·ªú NH·∫¨N DI·ªÜN...</div>
    </div>

    <div class="panel">
        <button class="btn" style="background:var(--primary)" onclick="switchTab('att')">CH·∫æ ƒê·ªò ƒêI·ªÇM DANH</button>
        <button class="btn" style="background:#334155" onclick="switchTab('reg')">QU·∫¢N L√ù D·ªÆ LI·ªÜU</button>
    </div>

    <div id="view-att" class="view active">
        <button class="btn" style="background:var(--success); margin-top: 10px; width: 90%; max-width:640px;" onclick="downloadCSV()">XU·∫§T B√ÅO C√ÅO (EXCEL)</button>
    </div>

    <div id="view-reg" class="view">
        <div class="reg-form">
            <input type="text" id="newName" placeholder="Nh·∫≠p t√™n h·ªçc sinh m·ªõi...">
            <button class="btn" style="background:var(--primary); width: 100%;" onclick="registerFace()">ƒêƒÇNG K√ù M·∫™U M·∫∂T</button>
            <div id="list-items" style="margin-top: 15px; max-height: 150px; overflow-y: auto; border-top: 1px solid #334155; padding-top: 10px;"></div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const statusMsg = document.getElementById('status-msg');
        let labeledFaceDescriptors = [];
        let attendanceLog = [["H·ªçc sinh", "Ng√†y", "Gi·ªù"]];
        
        // BI·∫æN TR·∫†NG TH√ÅI B·∫¢O M·∫¨T
        let hasBlinked = false;
        let hasMouthOpened = false;

        async function init() {
            const MODEL_URL = 'https://fastly.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            loadLocal();
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                document.getElementById('loading').style.display = 'none';
                startAI();
            };
        }

        function startAI() {
            const canvas = document.getElementById('overlay');
            const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 }))
                    .withFaceLandmarks().withFaceDescriptors();
                
                const resized = faceapi.resizeResults(detections, displaySize);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (resized.length === 0) {
                    hasBlinked = false; hasMouthOpened = false;
                    statusMsg.innerText = "M·ªúI ƒê·ª®NG V√ÄO KHUNG H√åNH";
                    statusMsg.style.color = "white";
                    return;
                }

                resized.forEach(det => {
                    const landmarks = det.landmarks;
                    
                    // 1. T√çNH EAR (CH·ªöP M·∫ÆT)
                    const ear = (getEAR(landmarks.getLeftEye()) + getEAR(landmarks.getRightEye())) / 2;
                    if (ear < 0.26) hasBlinked = true;

                    // 2. T√çNH MAR (H√Å MI·ªÜNG)
                    const mouth = landmarks.getMouth();
                    const mar = getMAR(mouth);
                    if (mar > 0.45) hasMouthOpened = true;

                    // HI·ªÇN TH·ªä CH·ªà S·ªê TR√äN M·∫∂T (ƒê·ªÉ Ban gi√°m kh·∫£o th·∫•y AI ƒëang t√≠nh to√°n)
                    ctx.fillStyle = "#00cec9";
                    ctx.fillText(`EAR: ${ear.toFixed(2)}`, det.detection.box.x, det.detection.box.y - 30);
                    ctx.fillStyle = "#f1c40f";
                    ctx.fillText(`MAR: ${mar.toFixed(2)}`, det.detection.box.x, det.detection.box.y - 15);

                    if (!hasBlinked) {
                        statusMsg.innerText = "X√ÅC MINH SINH TR·∫ÆC H·ªåC: M·ªúI B·∫†N CH·ªöP M·∫ÆT";
                        statusMsg.style.color = "var(--warning)";
                        new faceapi.draw.DrawBox(det.detection.box, { label: "L·ªõp 1: Ch·ªù ch·ªõp m·∫Øt", boxColor: "red" }).draw(canvas);
                    } else if (!hasMouthOpened) {
                        statusMsg.innerText = "X√ÅC MINH SINH TR·∫ÆC H·ªåC: M·ªúI B·∫†N H√Å MI·ªÜNG";
                        statusMsg.style.color = "var(--warning)";
                        new faceapi.draw.DrawBox(det.detection.box, { label: "L·ªõp 2: Ch·ªù h√° mi·ªáng", boxColor: "orange" }).draw(canvas);
                    } else {
                        // V∆Ø·ª¢T QUA B·∫¢O M·∫¨T -> NH·∫¨N DI·ªÜN DANH T√çNH
                        const matcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5);
                        const best = matcher.findBestMatch(det.descriptor);
                        
                        if (best.label !== 'unknown') {
                            statusMsg.innerHTML = `ƒê√É GHI DANH: <b style="color:var(--success)">${best.label}</b>`;
                            record(best.label);
                        } else {
                            statusMsg.innerHTML = `<b style="color:var(--danger)">C·∫¢NH B√ÅO: NG∆Ø·ªúI L·∫†</b>`;
                        }
                        new faceapi.draw.DrawBox(det.detection.box, { label: "X√ÅC TH·ª∞C TH√ÄNH C√îNG", boxColor: "green" }).draw(canvas);
                    }
                });
            }, 200);
        }

        function getEAR(eye) {
            const p2_p6 = Math.sqrt(Math.pow(eye[1].x - eye[5].x, 2) + Math.pow(eye[1].y - eye[5].y, 2));
            const p3_p5 = Math.sqrt(Math.pow(eye[2].x - eye[4].x, 2) + Math.pow(eye[2].y - eye[4].y, 2));
            const p1_p4 = Math.sqrt(Math.pow(eye[0].x - eye[3].x, 2) + Math.pow(eye[0].y - eye[3].y, 2));
            return (p2_p6 + p3_p5) / (2.0 * p1_p4);
        }

        function getMAR(mouth) {
            const vertical = Math.sqrt(Math.pow(mouth[14].x - mouth[18].x, 2) + Math.pow(mouth[14].y - mouth[18].y, 2));
            const horizontal = Math.sqrt(Math.pow(mouth[12].x - mouth[16].x, 2) + Math.pow(mouth[12].y - mouth[16].y, 2));
            return vertical / horizontal;
        }

        async function registerFace() {
            const name = document.getElementById('newName').value;
            if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n!");
            statusMsg.innerText = "ƒêANG QU√âT M·∫™U SINH TR·∫ÆC...";
            const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 })).withFaceLandmarks().withFaceDescriptor();
            if (det) {
                labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [det.descriptor]));
                saveLocal(); render(); 
                document.getElementById('newName').value = "";
                alert("ƒêƒÉng k√Ω th√†nh c√¥ng d·ªØ li·ªáu cho: " + name);
            }
        }

        function record(name) {
            const d = new Date();
            const date = d.toLocaleDateString('vi-VN');
            if (!attendanceLog.some(r => r[0] === name && r[1] === date)) {
                attendanceLog.push([name, date, d.toLocaleTimeString('vi-VN')]);
            }
        }

        function saveLocal() { localStorage.setItem('khkt_smart_checkin_final', JSON.stringify(labeledFaceDescriptors.map(ld => ({ label: ld.label, descriptors: ld.descriptors.map(d => Array.from(d)) })))); }
        function loadLocal() {
            const data = localStorage.getItem('khkt_smart_checkin_final');
            if (data) {
                const parsed = JSON.parse(data);
                labeledFaceDescriptors = parsed.map(d => new faceapi.LabeledFaceDescriptors(d.label, d.descriptors.map(a => new Float32Array(a))));
                render();
            }
        }
        function render() {
            document.getElementById('list-items').innerHTML = labeledFaceDescriptors.map((ld, i) => `<div style="display:flex; justify-content:space-between; margin-bottom:8px; background:#0f172a; padding:8px; border-radius:5px;"><span>üë§ ${ld.label}</span><button onclick="del(${i})" style="color:var(--danger); background:none; border:none; cursor:pointer">X√≥a</button></div>`).join('');
        }
        function del(i) { if(confirm("X√≥a h·ªçc sinh n√†y kh·ªèi h·ªá th·ªëng?")) { labeledFaceDescriptors.splice(i,1); saveLocal(); render(); } }
        function switchTab(t) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + t).classList.add('active');
        }
        function downloadCSV() {
            let csv = "\ufeff" + attendanceLog.map(r => r.join(",")).join("\n");
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            a.download = 'BaoCao_DiemDanh_AI.csv'; a.click();
        }

        init();
    </script>
</body>
</html>
