<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªÜ TH·ªêNG ƒêI·ªÇM DANH TH√îNG MINH AI</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #0984e3; --accent: #00cec9; --bg: #0f172a; --success: #00b894; --warning: #f1c40f; --danger: #d63031; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; }
        
        #loading { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--accent); }
        .loader { width: 50px; height: 50px; border: 4px solid #333; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        header { background: rgba(30, 41, 59, 0.8); width: 100%; padding: 20px 0; text-align: center; border-bottom: 2px solid var(--primary); }
        header h2 { margin: 0; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; }

        #webcam-wrapper { position: relative; width: 90%; max-width: 640px; aspect-ratio: 4/3; margin-top: 20px; border-radius: 15px; overflow: hidden; border: 3px solid #334155; box-shadow: 0 0 30px rgba(9, 132, 227, 0.2); }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; }

        .status-box { width: 90%; max-width: 640px; margin-top: 15px; padding: 15px; background: #1e293b; border-radius: 10px; text-align: center; border: 1px solid #334155; }
        #status-msg { font-weight: bold; font-size: 1.1rem; }

        .panel { width: 90%; max-width: 640px; margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        
        .view { display: none; width: 100%; flex-direction: column; align-items: center; }
        .view.active { display: flex; }
        
        .reg-form { width: 90%; background: #1e293b; padding: 20px; border-radius: 15px; margin-top: 10px; box-sizing: border-box; }
        input { padding: 12px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="loader"></div>
        <p>ƒêANG KH·ªûI T·∫†O H·ªÜ TH·ªêNG AI...</p>
    </div>

    <header>
        <h2>H·ªÜ TH·ªêNG ƒêI·ªÇM DANH TH√îNG MINH AI</h2>
    </header>

    <div id="webcam-wrapper">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    <div class="status-box">
        <div id="status-msg" style="color: var(--warning);">VUI L√íNG ƒê·ª®NG TR∆Ø·ªöC CAMERA</div>
    </div>

    <div class="panel">
        <button class="btn" style="background:var(--primary)" onclick="switchTab('att')">ƒêI·ªÇM DANH</button>
        <button class="btn" style="background:#334155" onclick="switchTab('reg')">QU·∫¢N L√ù TH√ÄNH VI√äN</button>
    </div>

    <div id="view-att" class="view active">
        <button class="btn" style="background:var(--success); margin-top: 10px; width: 90%; max-width:640px;" onclick="downloadCSV()">XU·∫§T B√ÅO C√ÅO EXCEL</button>
    </div>

    <div id="view-reg" class="view">
        <div class="reg-form">
            <input type="text" id="newName" placeholder="Nh·∫≠p t√™n h·ªçc sinh...">
            <button class="btn" style="background:var(--primary); width: 100%;" onclick="registerFace()">ƒêƒÇNG K√ù KHU√îN M·∫∂T</button>
            <div id="list-items" style="margin-top: 15px; max-height: 150px; overflow-y: auto; border-top: 1px solid #334155; padding-top: 10px;"></div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const statusMsg = document.getElementById('status-msg');
        let labeledFaceDescriptors = [];
        let attendanceLog = [["T√™n h·ªçc sinh", "Ng√†y", "Gi·ªù"]];
        
        let hasBlinked = false;
        let hasTurned = false;

        async function init() {
            const MODEL_URL = 'https://fastly.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            loadLocal();
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                document.getElementById('loading').style.display = 'none';
                startAI();
            };
        }

        function startAI() {
            const canvas = document.getElementById('overlay');
            const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 }))
                    .withFaceLandmarks().withFaceDescriptors();
                
                const resized = faceapi.resizeResults(detections, displaySize);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (resized.length === 0) {
                    hasBlinked = false; hasTurned = false;
                    statusMsg.innerText = "CH·ªú NG∆Ø·ªúI D√ôNG...";
                    statusMsg.style.color = "var(--warning)";
                    return;
                }

                resized.forEach(det => {
                    const landmarks = det.landmarks;
                    
                    // Ki·ªÉm tra b·∫£o m·∫≠t (Ch·ªõp m·∫Øt & Nghi√™ng ƒë·∫ßu)
                    const ear = (getEAR(landmarks.getLeftEye()) + getEAR(landmarks.getRightEye())) / 2;
                    if (ear < 0.28) hasBlinked = true;

                    const noseX = landmarks.getNose()[0].x;
                    const jaw = landmarks.getJawOutline();
                    const nosePos = (noseX - jaw[0].x) / (jaw[16].x - jaw[0].x);
                    if (nosePos < 0.45 || nosePos > 0.55) hasTurned = true;

                    if (!hasBlinked || !hasTurned) {
                        statusMsg.innerText = "X√ÅC MINH SINH TR·∫ÆC H·ªåC (CH·ªöP M·∫ÆT & NGHI√äNG NH·∫∏)...";
                        statusMsg.style.color = "var(--warning)";
                        new faceapi.draw.DrawBox(det.detection.box, { label: "Verifying...", boxColor: "red" }).draw(canvas);
                    } else {
                        const matcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5);
                        const best = matcher.findBestMatch(det.descriptor);
                        
                        if (best.label !== 'unknown') {
                            statusMsg.innerHTML = `ƒê√É GHI DANH: <b style="color:var(--success)">${best.label}</b>`;
                            record(best.label);
                        } else {
                            statusMsg.innerHTML = `<b style="color:var(--danger)">C·∫¢NH B√ÅO: KH√îNG C√ì TRONG D·ªÆ LI·ªÜU</b>`;
                        }
                        new faceapi.draw.DrawBox(det.detection.box, { label: "X√ÅC TH·ª∞C TH√ÄNH C√îNG", boxColor: "green" }).draw(canvas);
                    }
                });
            }, 250);
        }

        function getEAR(eye) {
            const p2_p6 = Math.sqrt(Math.pow(eye[1].x - eye[5].x, 2) + Math.pow(eye[1].y - eye[5].y, 2));
            const p3_p5 = Math.sqrt(Math.pow(eye[2].x - eye[4].x, 2) + Math.pow(eye[2].y - eye[4].y, 2));
            const p1_p4 = Math.sqrt(Math.pow(eye[0].x - eye[3].x, 2) + Math.pow(eye[0].y - eye[3].y, 2));
            return (p2_p6 + p3_p5) / (2.0 * p1_p4);
        }

        async function registerFace() {
            const name = document.getElementById('newName').value;
            if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n h·ªçc sinh!");
            statusMsg.innerText = "ƒêANG CH·ª§P M·∫™U KHU√îN M·∫∂T...";
            const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 })).withFaceLandmarks().withFaceDescriptor();
            if (det) {
                labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [det.descriptor]));
                saveLocal(); render(); 
                document.getElementById('newName').value = "";
                alert("ƒêƒÉng k√Ω th√†nh c√¥ng!");
            }
        }

        function record(name) {
            const d = new Date();
            const date = d.toLocaleDateString('vi-VN');
            if (!attendanceLog.some(r => r[0] === name && r[1] === date)) {
                attendanceLog.push([name, date, d.toLocaleTimeString('vi-VN')]);
            }
        }

        function saveLocal() { localStorage.setItem('ai_smart_checkin', JSON.stringify(labeledFaceDescriptors.map(ld => ({ label: ld.label, descriptors: ld.descriptors.map(d => Array.from(d)) })))); }
        function loadLocal() {
            const data = localStorage.getItem('ai_smart_checkin');
            if (data) {
                const parsed = JSON.parse(data);
                labeledFaceDescriptors = parsed.map(d => new faceapi.LabeledFaceDescriptors(d.label, d.descriptors.map(a => new Float32Array(a))));
                render();
            }
        }
        function render() {
            document.getElementById('list-items').innerHTML = labeledFaceDescriptors.map((ld, i) => `<div style="display:flex; justify-content:space-between; margin-bottom:8px; background:#0f172a; padding:5px; border-radius:5px;"><span>üë§ ${ld.label}</span><button onclick="del(${i})" style="color:var(--danger); background:none; border:none; cursor:pointer">X√≥a</button></div>`).join('');
        }
        function del(i) { if(confirm("X√≥a h·ªçc sinh n√†y?")) { labeledFaceDescriptors.splice(i,1); saveLocal(); render(); } }
        function switchTab(t) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + t).classList.add('active');
        }
        function downloadCSV() {
            let csv = "\ufeff" + attendanceLog.map(r => r.join(",")).join("\n");
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            a.download = 'DanhSach_DiemDanh.csv'; a.click();
        }

        init();
    </script>
</body>
</html>
