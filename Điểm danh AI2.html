<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Facial Recognition System</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary-color: #0c2461; --accent-color: #1e90ff; --success-color: #2ecc71; --error-color: #e74c3c; --text-main: #2f3640; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f5f6fa; margin: 0; display: flex; flex-direction: column; align-items: center; color: var(--text-main); }
        
        /* Header chuyên nghiệp */
        header { 
            width: 100%; padding: 15px 50px; background: white; box-sizing: border-box;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-bottom: 3px solid var(--primary-color);
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .school-logo { width: 55px; height: 55px; object-fit: contain; }
        .system-title h1 { margin: 0; font-size: 1.4rem; color: var(--primary-color); letter-spacing: 1px; }
        .system-title p { margin: 0; font-size: 0.85rem; color: #7f8c8d; }

        .main-layout { display: flex; gap: 30px; padding: 30px; width: 95%; max-width: 1200px; box-sizing: border-box; }
        
        /* Cột trái: Camera */
        .camera-section { flex: 1.5; }
        .video-container { 
            position: relative; width: 100%; border-radius: 12px; overflow: hidden; 
            background: #000; border: 4px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        video, canvas { width: 100%; display: block; }
        #overlay { position: absolute; top: 0; left: 0; }
        .scan-line { 
            position: absolute; width: 100%; height: 2px; background: var(--accent-color); 
            top: 0; left: 0; z-index: 10; display: none;
            box-shadow: 0 0 15px var(--accent-color); animation: moveLine 3s linear infinite;
        }
        @keyframes moveLine { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }

        /* Cột phải: Thông tin */
        .info-section { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .status-box { text-align: center; font-weight: bold; font-size: 1.1rem; min-height: 50px; display: flex; align-items: center; justify-content: center; border: 2px solid #eee; border-radius: 8px; margin-bottom: 15px; }
        .alert-mode { color: var(--error-color); border-color: var(--error-color); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .otp-display { font-size: 3.5rem; font-weight: 800; color: var(--primary-color); text-align: center; letter-spacing: 10px; display: none; margin: 15px 0; }
        .progress-container { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; display: none; }
        #progress-fill { width: 0%; height: 100%; background: var(--success-color); transition: 0.3s; }

        /* Tab và Danh sách */
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 15px; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: bold; color: #95a5a6; }
        .tab-btn.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        
        .student-list { max-height: 300px; overflow-y: auto; }
        .student-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; background: #f9f9f9; border-radius: 8px; margin-bottom: 8px;
            border-left: 5px solid #dcdde1; transition: 0.2s;
        }
        .student-item:hover { background: #f1f2f6; border-left-color: var(--accent-color); }
        .delete-btn { background: none; border: 1px solid #fab1a0; color: #ff7675; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }
        .delete-btn:hover { background: #ff7675; color: white; }

        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-reg { background: var(--success-color); }
        .btn-export { background: var(--primary-color); margin-top: 10px; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <img src="ảnh logo trường.png" class="school-logo" alt="School Logo">
        <div class="system-title">
            <h1>HỆ THỐNG ĐIỂM DANH AI</h1>
            <p>Smart Attendance & Liveness Detection System</p>
        </div>
    </div>
    <div id="clock" style="font-weight: bold; color: var(--primary-color)">00:00:00</div>
</header>

<div class="main-layout">
    <section class="camera-section">
        <div class="video-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="overlay"></canvas>
            <div id="scan-line" class="scan-line"></div>
        </div>
    </section>

    <section class="info-section">
        <div class="card">
            <div id="status-box" class="status-box">Đang khởi tạo hệ thống...</div>
            <div id="otp-view" class="otp-display">000000</div>
            <div id="progress-view" class="progress-container">
                <div id="progress-fill"></div>
            </div>
            
            <div class="tabs">
                <button id="btn-at" class="tab-btn active" onclick="switchMode('at')">Điểm Danh</button>
                <button id="btn-re" class="tab-btn" onclick="switchMode('re')">Đăng Ký</button>
            </div>

            <div id="panel-at">
                <button class="btn-action btn-export" onclick="exportData()">Xuất Báo Cáo (CSV)</button>
            </div>

            <div id="panel-re" style="display: none;">
                <input type="text" id="nameInput" placeholder="Nhập họ và tên học sinh...">
                <button class="btn-action btn-reg" onclick="registerFace()">Chụp Mẫu Khuôn Mặt</button>
                <div class="student-list" id="student-list" style="margin-top: 15px;"></div>
            </div>
        </div>
    </section>
</div>

<script>
    const video = document.getElementById('video');
    const statusBox = document.getElementById('status-box');
    const otpView = document.getElementById('otp-view');
    const progressFill = document.getElementById('progress-fill');
    const progressView = document.getElementById('progress-view');
    const scanLine = document.getElementById('scan-line');

    let faceMatcher = null;
    let labeledDescriptors = [];
    let logs = [["Họ Tên", "Ngày", "Giờ Xuất Hiện"]];
    let isChallenging = false, mouthCounter = 0, isVerified = false, internalTimer = 0;

    // Khởi tạo
    async function start() {
        const MODEL_URL = 'https://fastly.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        
        loadSavedData();
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640 } });
        video.srcObject = stream;
        
        setInterval(updateClock, 1000);
        processAI();
    }

    function updateClock() {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('vi-VN');
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        msg.voice = voices.find(v => v.name.includes('Google') && v.lang.includes('vi')) || voices.find(v => v.lang.includes('vi'));
        msg.lang = 'vi-VN';
        window.speechSynthesis.speak(msg);
    }

    async function processAI() {
        setInterval(async () => {
            if (video.readyState !== 4 || document.getElementById('panel-re').style.display === 'block') return;

            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 160, scoreThreshold: 0.3 }))
                .withFaceLandmarks().withFaceDescriptors();

            const canvas = document.getElementById('overlay');
            const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
            faceapi.matchDimensions(canvas, displaySize);
            const resizedResults = faceapi.resizeResults(detections, displaySize);
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

            if (resizedResults.length > 0) {
                statusBox.classList.remove('alert-mode');
                scanLine.style.display = 'block';

                if (!isChallenging && !isVerified) {
                    internalTimer += 300;
                    statusBox.innerText = "ĐANG PHÂN TÍCH SINH TRẮC HỌC...";
                    
                    if (internalTimer >= 10000) { // Đếm ngầm 10 giây
                        isChallenging = true;
                        otpView.innerText = Math.floor(100000 + Math.random() * 900000);
                        otpView.style.display = 'block';
                        progressView.style.display = 'block';
                        statusBox.innerText = "XÁC MINH CỬ ĐỘNG MÔI";
                        speak("Mời bạn, đọc mã số trên màn hình");
                    }
                }

                if (isChallenging) {
                    const landmarks = resizedResults[0].landmarks;
                    const mouth = landmarks.getMouth();
                    const dist = Math.abs(mouth[14].y - mouth[18].y);
                    if (dist > 10) mouthCounter++;
                    progressFill.style.width = (mouthCounter * 10) + '%';

                    if (mouthCounter >= 10) {
                        isChallenging = false; isVerified = true;
                        otpView.style.display = 'none'; progressView.style.display = 'none';
                    }
                } else if (isVerified) {
                    if (labeledDescriptors.length > 0) {
                        const matcher = new faceapi.FaceMatcher(labeledDescriptors, 0.45);
                        const bestMatch = matcher.findBestMatch(resizedResults[0].descriptor);
                        if (bestMatch.label !== 'unknown') {
                            statusBox.innerHTML = `XÁC NHẬN: <span style="color:var(--success-color)">${bestMatch.label}</span>`;
                            logAttendance(bestMatch.label);
                        } else {
                            statusBox.innerText = "DỮ LIỆU KHÔNG HỢP LỆ";
                        }
                    } else { statusBox.innerText = "CHƯA CÓ DỮ LIỆU HỌC SINH"; }
                }
            } else {
                internalTimer = 0; mouthCounter = 0; isChallenging = false; isVerified = false;
                scanLine.style.display = 'none'; otpView.style.display = 'none'; progressView.style.display = 'none';
                statusBox.innerText = "KHÔNG TÌM THẤY GƯƠNG MẶT";
                statusBox.classList.add('alert-mode');
            }
        }, 300);
    }

    async function registerFace() {
        const name = document.getElementById('nameInput').value.trim();
        if (!name) return alert("Vui lòng nhập họ tên!");

        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ scoreThreshold: 0.3 }))
            .withFaceLandmarks().withFaceDescriptor();

        if (detection) {
            labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]));
            saveToLocal();
            renderStudentList();
            document.getElementById('nameInput').value = "";
            alert("Đăng ký thành công học sinh: " + name);
        } else {
            alert("Không thể quét khuôn mặt. Vui lòng thử lại!");
        }
    }

    function deleteStudent(index) {
        if (confirm("Xóa dữ liệu sinh trắc học của học sinh này?")) {
            labeledDescriptors.splice(index, 1);
            saveToLocal();
            renderStudentList();
        }
    }

    function logAttendance(name) {
        const date = new Date().toLocaleDateString('vi-VN');
        const time = new Date().toLocaleTimeString('vi-VN');
        if (!logs.some(entry => entry[0] === name && entry[1] === date)) {
            logs.push([name, date, time]);
            speak("Xác nhận thành công. Chào bạn " + name);
        }
    }

    function saveToLocal() {
        const data = labeledDescriptors.map(ld => ({ label: ld.label, descriptors: ld.descriptors.map(d => Array.from(d)) }));
        localStorage.setItem('ai_attendance_pro', JSON.stringify(data));
    }

    function loadSavedData() {
        const data = localStorage.getItem('ai_attendance_pro');
        if (data) {
            labeledDescriptors = JSON.parse(data).map(d => new faceapi.LabeledFaceDescriptors(d.label, d.descriptors.map(desc => new Float32Array(desc))));
            renderStudentList();
        }
    }

    function renderStudentList() {
        const listDiv = document.getElementById('student-list');
        listDiv.innerHTML = labeledDescriptors.map((d, i) => `
            <div class="student-item">
                <span>${d.label}</span>
                <button class="delete-btn" onclick="deleteStudent(${i})">Xóa</button>
            </div>
        `).join('');
    }

    function switchMode(mode) {
        document.getElementById('panel-at').style.display = mode === 'at' ? 'block' : 'none';
        document.getElementById('panel-re').style.display = mode === 're' ? 'block' : 'none';
        document.getElementById('btn-at').classList.toggle('active', mode === 'at');
        document.getElementById('btn-re').classList.toggle('active', mode === 're');
    }

    function exportData() {
        let csvContent = "\ufeff" + logs.map(e => e.join(",")).join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Attendance_Report_${new Date().toLocaleDateString()}.csv`;
        link.click();
    }

    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
    start();
</script>
</body>
</html>
