<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªÜ TH·ªêNG ƒêI·ªÇM DANH TH√îNG MINH AI</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
    :root { 
        --primary: #0984e3; --accent: #00cec9; --bg: #0f172a; 
        --success: #00b894; --warning: #f1c40f; --danger: #d63031; 
    }

    body { 
        font-family: 'Segoe UI', sans-serif; margin: 0; 
        background: var(--bg); color: white; 
        display: flex; flex-direction: column; align-items: center;
        min-height: 100vh; padding: 10px; box-sizing: border-box;
    }

    /* Khung ch·ª©a Video: Quan tr·ªçng nh·∫•t */
    #webcam-wrapper { 
        position: relative; 
        width: 100%;           /* Full chi·ªÅu r·ªông tr√™n di ƒë·ªông */
        max-width: 640px;      /* Kh√¥ng qu√° 640px tr√™n m√°y t√≠nh */
        aspect-ratio: 4/3;     /* Lu√¥n gi·ªØ t·ªâ l·ªá khung h√¨nh 4:3 */
        margin-top: 15px; 
        border-radius: 12px; 
        overflow: hidden; 
        border: 2px solid #334155; 
        background: #000;
    }

    video, canvas { 
        position: absolute; top: 0; left: 0; 
        width: 100%; height: 100%; object-fit: cover; 
    }

    /* H·ªôp tr·∫°ng th√°i v√† B·∫£ng ƒëi·ªÅu khi·ªÉn */
    .status-box, .control-panel, .view { 
        width: 100%; 
        max-width: 640px; 
        box-sizing: border-box; 
    }

    .control-panel { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 10px; 
        margin-top: 15px; 
    }

    /* T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh cho m√†n h√¨nh si√™u nh·ªè (ƒëi·ªán tho·∫°i d·ªçc) */
    @media (max-width: 480px) {
        header h2 { font-size: 1.2rem; }
        #otp-number { font-size: 1.8rem; letter-spacing: 5px; }
        .tab-btn { padding: 10px 5px; font-size: 0.8rem; }
    }
</style>
</head>
<body>

<div id="loading"><h1>ƒêANG T·∫¢I AI...</h1></div>

<header><h2>H·ªÜ TH·ªêNG ƒêI·ªÇM DANH TH√îNG MINH AI</h2></header>

<div id="webcam-wrapper">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
</div>

<div class="status-box">
    <div id="otp-box">
        <div style="color: var(--danger); font-size: 0.9rem; margin-bottom: 5px;">X√ÅC TH·ª∞C NG∆Ø·ªúI TH·∫¨T: ƒê·ªåC TO D√ÉY S·ªê</div>
        <div id="otp-number">000 000</div>
    </div>
    <div id="status-msg">CH·ªú QU√âT KHU√îN M·∫∂T...</div>
</div>

<div class="control-panel">
    <button id="btn-att" class="tab-btn active" onclick="switchTab('att')">ƒêI·ªÇM DANH</button>
    <button id="btn-reg" class="tab-btn" onclick="switchTab('reg')">ƒêƒÇNG K√ù H·ªåC SINH</button>
</div>

<div id="view-att" class="view active">
    <button class="action-btn" style="background: var(--success);" onclick="downloadCSV()">XU·∫§T B√ÅO C√ÅO EXCEL</button>
</div>

<div id="view-reg" class="view">
    <input type="text" id="newName" placeholder="Nh·∫≠p t√™n h·ªçc sinh...">
    <button class="action-btn" style="background: var(--primary);" onclick="registerFace()">CH·ª§P ·∫¢NH ƒêƒÇNG K√ù</button>
    <div id="list-items" style="margin-top: 15px; max-height: 100px; overflow-y: auto; border-top: 1px solid #444; padding-top: 10px;"></div>
</div>

<script>
    const video = document.getElementById('video');
    const statusMsg = document.getElementById('status-msg');
    const otpBox = document.getElementById('otp-box');
    const otpNum = document.getElementById('otp-number');
    let labeledFaceDescriptors = [];
    let attendanceLog = [["T√™n", "Ng√†y", "Gi·ªù"]];
    
    let isChallenging = false;
    let mouthMoves = 0;
    let challengePassed = false;
    let currentMode = 'att'; // 'att' ho·∫∑c 'reg'

    async function init() {
        const MODEL_URL = 'https://fastly.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        loadLocal();
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            document.getElementById('loading').style.display = 'none';
            runAI();
        };
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'vi-VN';
        window.speechSynthesis.speak(u);
    }

    async function runAI() {
        const canvas = document.getElementById('overlay');
        const displaySize = { width: 640, height: 480 };
        faceapi.matchDimensions(canvas, displaySize);

        setInterval(async () => {
            if (currentMode !== 'att') {
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 256 }))
                .withFaceLandmarks().withFaceDescriptors();
            const resized = faceapi.resizeResults(detections, displaySize);
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

            if (resized.length > 0) {
                const det = resized[0];
                const mar = getMAR(det.landmarks.getMouth());

                // Logic k√≠ch ho·∫°t ƒë·ªçc s·ªë khi nghi ng·ªù
                if (!isChallenging && !challengePassed) {
                    isChallenging = true;
                    const otp = Math.floor(100000 + Math.random() * 900000);
                    otpNum.innerText = otp.toString().split('').join(' ');
                    otpBox.style.display = 'block';
                    speak("Ph√°t hi·ªán nghi ng·ªù, m·ªùi b·∫°n ƒë·ªçc d√£y s·ªë tr√™n m√†n h√¨nh");
                }

                if (isChallenging) {
                    if (mar > 0.15) mouthMoves++; 
                    if (mouthMoves > 30) {
                        isChallenging = false;
                        challengePassed = true;
                        otpBox.style.display = 'none';
                    }
                    new faceapi.draw.DrawBox(det.detection.box, { label: "X√ÅC MINH MI·ªÜNG...", boxColor: "red" }).draw(canvas);
                } else if (challengePassed) {
                    const matcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5);
                    const best = matcher.findBestMatch(det.descriptor);
                    
                    if (best.label !== 'unknown') {
                        statusMsg.innerHTML = `<b style="color:var(--success)">ƒê√É GHI DANH: ${best.label}</b>`;
                        record(best.label);
                    }
                    new faceapi.draw.DrawBox(det.detection.box, { label: "AN TO√ÄN", boxColor: "green" }).draw(canvas);
                }
            }
        }, 150);
    }

    async function registerFace() {
        const name = document.getElementById('newName').value;
        if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n!");
        const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        if (det) {
            labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [det.descriptor]));
            saveLocal(); render();
            alert("ƒê√£ ƒëƒÉng k√Ω: " + name);
        }
    }

    function getMAR(mouth) {
        const v = Math.sqrt(Math.pow(mouth[14].x - mouth[18].x, 2) + Math.pow(mouth[14].y - mouth[18].y, 2));
        const h = Math.sqrt(Math.pow(mouth[12].x - mouth[16].x, 2) + Math.pow(mouth[12].y - mouth[16].y, 2));
        return v / h;
    }

    function switchTab(mode) {
        currentMode = mode;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('view-' + mode).classList.add('active');
        document.getElementById('btn-' + mode).classList.add('active');
        // Reset b·∫£o m·∫≠t khi chuy·ªÉn tab
        challengePassed = false; isChallenging = false; mouthMoves = 0; otpBox.style.display = 'none';
    }

    function record(name) {
        const d = new Date();
        const date = d.toLocaleDateString('vi-VN');
        if (!attendanceLog.some(r => r[0] === name && r[1] === date)) {
            attendanceLog.push([name, date, d.toLocaleTimeString('vi-VN')]);
            speak("Ch√†o m·ª´ng " + name);
        }
    }

    function saveLocal() { localStorage.setItem('ai_db', JSON.stringify(labeledFaceDescriptors.map(ld => ({ label: ld.label, descriptors: ld.descriptors.map(d => Array.from(d)) })))); }
    function loadLocal() {
        const data = localStorage.getItem('ai_db');
        if (data) {
            const parsed = JSON.parse(data);
            labeledFaceDescriptors = parsed.map(d => new faceapi.LabeledFaceDescriptors(d.label, d.descriptors.map(a => new Float32Array(a))));
            render();
        }
    }
    function render() {
        document.getElementById('list-items').innerHTML = labeledFaceDescriptors.map((ld, i) => `<div style="display:flex; justify-content:space-between; padding:5px;"><span>üë§ ${ld.label}</span></div>`).join('');
    }
    function downloadCSV() {
        let csv = "\ufeff" + attendanceLog.map(r => r.join(",")).join("\n");
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
        a.download = 'DiemDanh.csv'; a.click();
    }

    init();
</script>
</body>
</html>

