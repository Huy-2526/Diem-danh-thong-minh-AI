<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Facial Recognition - Speed Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary-color: #0c2461; --accent-color: #1e90ff; --success-color: #2ecc71; --error-color: #e74c3c; --text-main: #2f3640; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f5f6fa; margin: 0; display: flex; flex-direction: column; align-items: center; color: var(--text-main); height: 100vh; overflow: hidden; }
        
        /* Header chuy√™n nghi·ªáp */
        header { 
            width: 100%; padding: 10px 20px; background: white; box-sizing: border-box;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-bottom: 3px solid var(--primary-color);
            z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .school-logo { width: 45px; height: 45px; object-fit: contain; }
        .system-title h1 { margin: 0; font-size: 1.2rem; color: var(--primary-color); letter-spacing: 1px; }
        .system-title p { margin: 0; font-size: 0.75rem; color: #7f8c8d; }
        #clock { font-weight: bold; color: var(--primary-color); font-size: 1rem; }

        .main-layout { display: flex; gap: 20px; padding: 20px; width: 100%; max-width: 1200px; box-sizing: border-box; height: calc(100vh - 70px); }
        
        /* C·ªôt tr√°i: Camera */
        .camera-section { flex: 1.5; display: flex; flex-direction: column; justify-content: center; }
        .video-container { 
            position: relative; width: 100%; border-radius: 12px; overflow: hidden; 
            background: #000; border: 4px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            aspect-ratio: 4/3; /* Gi·ªØ t·ª∑ l·ªá khung h√¨nh chu·∫©n */
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); /* L·∫≠t ng∆∞·ª£c g∆∞∆°ng cho gi·ªëng soi g∆∞∆°ng */ }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* Hi·ªáu ·ª©ng qu√©t */
        .scan-line { 
            position: absolute; width: 100%; height: 3px; background: var(--accent-color); 
            top: 0; left: 0; z-index: 10; display: none;
            box-shadow: 0 0 15px var(--accent-color); animation: moveLine 2s linear infinite;
        }
        @keyframes moveLine { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* C·ªôt ph·∫£i: Th√¥ng tin */
        .info-section { flex: 1; display: flex; flex-direction: column; gap: 15px; height: 100%; overflow: hidden; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 100%; }
        
        .status-box { 
            text-align: center; font-weight: bold; font-size: 1.2rem; min-height: 50px; 
            display: flex; align-items: center; justify-content: center; 
            border: 2px solid #eee; border-radius: 8px; margin-bottom: 15px; background: #fdfdfd;
            transition: 0.3s;
        }
        .success-mode { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }

        /* Tab v√† Danh s√°ch */
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 15px; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: bold; color: #95a5a6; transition: 0.3s; }
        .tab-btn.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: #ecf0f1; }
        
        .panel { flex: 1; overflow-y: auto; display: none; }
        .panel.active { display: flex; flex-direction: column; }

        .student-list { overflow-y: auto; flex: 1; }
        .student-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; background: #f9f9f9; border-radius: 6px; margin-bottom: 8px;
            border-left: 4px solid #dcdde1; 
        }
        .student-item:hover { background: #f1f2f6; border-left-color: var(--accent-color); }
        .delete-btn { background: #ffeaa7; border: none; color: #d63031; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; flex-shrink: 0; }
        .btn-reg { background: var(--success-color); }
        .btn-export { background: var(--primary-color); }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            body { height: auto; overflow: auto; }
            .main-layout { flex-direction: column; height: auto; padding: 10px; }
            .camera-section { flex: none; width: 100%; }
            .info-section { flex: none; width: 100%; height: auto; }
            .card { height: auto; min-height: 400px; }
            .system-title h1 { font-size: 1rem; }
            .system-title p { display: none; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <img src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" class="school-logo" alt="Logo">
        <div class="system-title">
            <h1>H·ªÜ TH·ªêNG ƒêI·ªÇM DANH AI</h1>
            <p>High Performance Recognition System</p>
        </div>
    </div>
    <div id="clock">00:00:00</div>
</header>

<div class="main-layout">
    <section class="camera-section">
        <div class="video-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="overlay"></canvas>
            <div id="scan-line" class="scan-line"></div>
        </div>
    </section>

    <section class="info-section">
        <div class="card">
            <div id="status-box" class="status-box">ƒêang kh·ªüi ƒë·ªông AI...</div>
            
            <div class="tabs">
                <button id="btn-at" class="tab-btn active" onclick="switchMode('at')">ƒêI·ªÇM DANH</button>
                <button id="btn-re" class="tab-btn" onclick="switchMode('re')">ƒêƒÇNG K√ù</button>
            </div>

            <div id="panel-at" class="panel active">
                <div style="flex:1; overflow-y: auto;">
                    <table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background:#eee; text-align:left;"><th style="padding:8px;">H·ªç T√™n</th><th style="padding:8px;">Th·ªùi Gian</th></tr>
                        </thead>
                        <tbody id="attendance-log-body">
                            </tbody>
                    </table>
                </div>
                <button class="btn-action btn-export" onclick="exportData()">XU·∫§T FILE EXCEL (CSV)</button>
            </div>

            <div id="panel-re" class="panel">
                <input type="text" id="nameInput" placeholder="Nh·∫≠p t√™n h·ªçc sinh m·ªõi...">
                <button class="btn-action btn-reg" onclick="registerFace()">CH·ª§P KHU√îN M·∫∂T</button>
                <div style="margin-top:10px; font-weight:bold; color:#7f8c8d;">Danh s√°ch ƒë√£ ƒëƒÉng k√Ω:</div>
                <div class="student-list" id="student-list"></div>
            </div>
        </div>
    </section>
</div>

<script>
    const video = document.getElementById('video');
    const statusBox = document.getElementById('status-box');
    const scanLine = document.getElementById('scan-line');

    let labeledDescriptors = [];
    let logs = []; // L∆∞u danh s√°ch ƒëi·ªÉm danh
    let isProcessing = false; // C·ªù ƒë·ªÉ tr√°nh x·ª≠ l√Ω ch·ªìng ch√©o

    // Kh·ªüi t·∫°o AI
    async function start() {
        const MODEL_URL = 'https://fastly.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
        
        statusBox.innerText = "ƒêang t·∫£i Model...";
        
        // Load song song c√°c model ƒë·ªÉ nhanh h∆°n
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), // Model nh·∫π nh·∫•t
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        
        loadSavedData();
        startCamera();
        
        setInterval(updateClock, 1000);
    }

    // Kh·ªüi ƒë·ªông Camera (H·ªó tr·ª£ c·∫£ Mobile)
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 },
                    facingMode: "user" // Camera tr∆∞·ªõc
                } 
            });
            video.srcObject = stream;
            
            // ƒê·ª£i video ch·∫°y r·ªìi m·ªõi k√≠ch ho·∫°t nh·∫≠n di·ªán
            video.onloadedmetadata = () => {
                video.play();
                statusBox.innerText = "S·∫µn s√†ng qu√©t!";
                processAI();
            };
        } catch (err) {
            statusBox.innerText = "L·ªói Camera: " + err.message;
            statusBox.style.color = "red";
        }
    }

    function updateClock() {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('vi-VN');
    }

    // H√†m ƒë·ªçc gi·ªçng n√≥i (ch·ªëng spam)
    let lastSpeakTime = 0;
    function speak(text) {
        const now = Date.now();
        if (now - lastSpeakTime < 3000) return; // Ch·ªâ n√≥i m·ªói 3 gi√¢y 1 l·∫ßn
        
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        // ∆Øu ti√™n gi·ªçng Vi·ªát Nam
        msg.voice = voices.find(v => v.lang.includes('vi')) || voices[0]; 
        msg.lang = 'vi-VN';
        window.speechSynthesis.speak(msg);
        lastSpeakTime = now;
    }

    // X·ª¨ L√ù AI CH√çNH (ƒê√£ t·ªëi ∆∞u)
    async function processAI() {
        const canvas = document.getElementById('overlay');
        const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
        faceapi.matchDimensions(canvas, displaySize);

        // Ch·∫°y v√≤ng l·∫∑p qu√©t
        setInterval(async () => {
            // N·∫øu ƒëang ·ªü tab ƒëƒÉng k√Ω th√¨ kh√¥ng qu√©t ƒë·ªÉ ti·∫øt ki·ªám CPU
            if (document.getElementById('panel-re').classList.contains('active')) return;

            // Ph√°t hi·ªán khu√¥n m·∫∑t
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.4 }))
                .withFaceLandmarks().withFaceDescriptors();

            // V·∫Ω khung l√™n canvas
            const resizeDetections = faceapi.resizeResults(detections, displaySize);
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            // faceapi.draw.drawDetections(canvas, resizeDetections); // B·ªè comment n·∫øu mu·ªën hi·ªán khung xanh

            if (detections.length > 0) {
                scanLine.style.display = 'block';
                
                // So s√°nh khu√¥n m·∫∑t
                if (labeledDescriptors.length > 0) {
                    const matcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5); // ƒê·ªô ch√≠nh x√°c 0.5
                    const bestMatch = matcher.findBestMatch(detections[0].descriptor);
                    
                    if (bestMatch.label !== 'unknown') {
                        handleAttendance(bestMatch.label);
                    } else {
                        statusBox.innerText = "Ch∆∞a nh·∫≠n di·ªán ƒë∆∞·ª£c...";
                        statusBox.classList.remove('success-mode');
                    }
                } else {
                    statusBox.innerText = "Ch∆∞a c√≥ d·ªØ li·ªáu h·ªçc sinh!";
                }
            } else {
                scanLine.style.display = 'none';
                statusBox.innerText = "ƒêang ch·ªù khu√¥n m·∫∑t...";
                statusBox.classList.remove('success-mode');
            }
        }, 200); // Qu√©t m·ªói 200ms (5fps) -> Nhanh h∆°n
    }

    // X·ª≠ l√Ω khi nh·∫≠n di·ªán th√†nh c√¥ng
    function handleAttendance(name) {
        const now = new Date();
        const dateStr = now.toLocaleDateString('vi-VN');
        const timeStr = now.toLocaleTimeString('vi-VN');

        // Ki·ªÉm tra xem h√¥m nay ƒë√£ ƒëi·ªÉm danh ch∆∞a
        const alreadyLogged = logs.find(log => log.name === name && log.date === dateStr);

        if (!alreadyLogged) {
            // Ghi nh·∫≠n m·ªõi
            logs.unshift({ name: name, date: dateStr, time: timeStr }); // Th√™m v√†o ƒë·∫ßu danh s√°ch
            updateLogTable();
            saveLogsToLocal(); // L∆∞u log v√†o b·ªô nh·ªõ
            
            // Hi·ªáu ·ª©ng UI
            statusBox.innerText = `‚úÖ ƒê√£ ƒëi·ªÉm danh: ${name}`;
            statusBox.classList.add('success-mode');
            speak("Xin ch√†o " + name);
        } else {
            // ƒê√£ ƒëi·ªÉm danh r·ªìi th√¨ ch·ªâ b√°o th√¥i, kh√¥ng ghi log n·ªØa
            statusBox.innerText = `üëå ${name} ƒë√£ ƒëi·ªÉm danh r·ªìi`;
            statusBox.classList.add('success-mode');
        }
    }

    // ƒêƒÉng k√Ω khu√¥n m·∫∑t m·ªõi
    async function registerFace() {
        const name = document.getElementById('nameInput').value.trim();
        if (!name) return alert("Vui l√≤ng nh·∫≠p h·ªç t√™n!");

        statusBox.innerText = "ƒêang ch·ª•p ·∫£nh...";
        
        // D√πng detectSingleFace cho ch√≠nh x√°c khi ƒëƒÉng k√Ω
        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks().withFaceDescriptor();

        if (detection) {
            // L∆∞u d·ªØ li·ªáu
            labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]));
            saveDataToLocal();
            renderStudentList();
            
            document.getElementById('nameInput').value = "";
            alert(`‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng: ${name}`);
            statusBox.innerText = "ƒêƒÉng k√Ω th√†nh c√¥ng!";
            switchMode('at'); // T·ª± ƒë·ªông chuy·ªÉn v·ªÅ tab ƒëi·ªÉm danh
        } else {
            alert("‚ö†Ô∏è Kh√¥ng th·∫•y khu√¥n m·∫∑t! H√£y ƒë·ª©ng g·∫ßn h∆°n.");
        }
    }

    // Qu·∫£n l√Ω d·ªØ li·ªáu LocalStorage
    function saveDataToLocal() {
        const data = labeledDescriptors.map(ld => ({ 
            label: ld.label, 
            descriptors: ld.descriptors.map(d => Array.from(d)) 
        }));
        localStorage.setItem('ai_data_v2', JSON.stringify(data));
    }

    function loadSavedData() {
        const data = localStorage.getItem('ai_data_v2');
        if (data) {
            labeledDescriptors = JSON.parse(data).map(d => 
                new faceapi.LabeledFaceDescriptors(d.label, d.descriptors.map(desc => new Float32Array(desc)))
            );
            renderStudentList();
        }
        
        // Load logs c≈©
        const oldLogs = localStorage.getItem('ai_logs_v2');
        if(oldLogs) {
            logs = JSON.parse(oldLogs);
            updateLogTable();
        }
    }
    
    function saveLogsToLocal() {
        localStorage.setItem('ai_logs_v2', JSON.stringify(logs));
    }

    function deleteStudent(index) {
        if (confirm("X√≥a h·ªçc sinh n√†y?")) {
            labeledDescriptors.splice(index, 1);
            saveDataToLocal();
            renderStudentList();
        }
    }

    // Render giao di·ªán
    function renderStudentList() {
        const listDiv = document.getElementById('student-list');
        listDiv.innerHTML = labeledDescriptors.map((d, i) => `
            <div class="student-item">
                <span>üë§ ${d.label}</span>
                <button class="delete-btn" onclick="deleteStudent(${i})">X√≥a</button>
            </div>
        `).join('');
    }

    function updateLogTable() {
        const tbody = document.getElementById('attendance-log-body');
        // Ch·ªâ hi·ªán 50 log g·∫ßn nh·∫•t
        tbody.innerHTML = logs.slice(0, 50).map(log => `
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:8px; color:var(--primary-color); font-weight:bold;">${log.name}</td>
                <td style="padding:8px;">${log.time}</td>
            </tr>
        `).join('');
    }

    // Chuy·ªÉn Tab
    function switchMode(mode) {
        document.getElementById('panel-at').classList.toggle('active', mode === 'at');
        document.getElementById('panel-re').classList.toggle('active', mode === 're');
        
        document.getElementById('btn-at').classList.toggle('active', mode === 'at');
        document.getElementById('btn-re').classList.toggle('active', mode === 're');
    }

    // Xu·∫•t file CSV
    function exportData() {
        let csvContent = "\ufeffH·ªç T√™n,Ng√†y,Gi·ªù\n" + logs.map(e => `${e.name},${e.date},${e.time}`).join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `DiemDanh_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    }

    // Fix l·ªói hi·ªÉn th·ªã video tr√™n m·ªôt s·ªë tr√¨nh duy·ªát
    video.addEventListener('play', () => {
        const canvas = document.getElementById('overlay');
        const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
        faceapi.matchDimensions(canvas, displaySize);
    });

    window.addEventListener('resize', () => {
        // T·ª± ƒë·ªông ch·ªânh l·∫°i khung canvas khi xoay m√†n h√¨nh
        const canvas = document.getElementById('overlay');
        const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
        faceapi.matchDimensions(canvas, displaySize);
    });

    // B·∫Øt ƒë·∫ßu
    start();
</script>
</body>
</html>
