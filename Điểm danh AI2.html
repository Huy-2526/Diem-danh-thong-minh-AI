<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI SMART CHECK-IN PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { 
            --primary: #0984e3; --accent: #00cec9; --bg: #0b0e14; 
            --success: #00b894; --warning: #f1c40f; --danger: #ff7675;
            --glass: rgba(255, 255, 255, 0.05);
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; background: var(--bg); color: white;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding: 10px; box-sizing: border-box;
            background: radial-gradient(circle at center, #1e293b 0%, #0b0e14 100%);
        }

        header { width: 100%; text-align: center; padding: 20px 0; }
        header h2 { 
            font-size: clamp(1.2rem, 5vw, 2rem); margin: 0; 
            background: linear-gradient(to right, var(--accent), #fff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase; letter-spacing: 3px; font-weight: 900;
        }

        /* Khung Camera hi·ªán ƒë·∫°i */
        #webcam-wrapper { 
            position: relative; width: 100%; max-width: 640px; aspect-ratio: 4/3;
            border-radius: 20px; overflow: hidden;
            border: 2px solid rgba(0, 206, 201, 0.3);
            box-shadow: 0 0 40px rgba(0, 206, 201, 0.15);
            background: #000;
        }

        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }

        /* H·ªôp OTP v√† Status */
        .status-box { 
            width: 100%; max-width: 640px; margin-top: 20px;
            padding: 20px; background: var(--glass); border-radius: 15px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        #otp-box { display: none; margin-bottom: 10px; }
        #otp-number { 
            font-size: clamp(2rem, 10vw, 3.5rem); color: var(--accent); 
            font-weight: 900; letter-spacing: 12px; margin: 10px 0;
            text-shadow: 0 0 20px rgba(0, 206, 201, 0.5);
        }

        /* Thanh nƒÉng l∆∞·ª£ng ƒë·ªçc s·ªë */
        .progress-container { width: 100%; background: rgba(255,255,255,0.1); height: 8px; border-radius: 10px; margin: 15px 0; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: var(--accent); box-shadow: 0 0 10px var(--accent); transition: 0.3s; }

        /* B·∫£ng ƒëi·ªÅu khi·ªÉn */
        .control-panel { width: 100%; max-width: 640px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .tab-btn { 
            padding: 15px; border: none; border-radius: 12px; font-weight: bold; 
            color: rgba(255,255,255,0.6); background: var(--glass); cursor: pointer; transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .tab-btn.active { color: #white; background: var(--primary); box-shadow: 0 0 20px rgba(9, 132, 227, 0.4); border-color: var(--primary); }

        .view { width: 100%; max-width: 640px; display: none; flex-direction: column; margin-top: 15px; }
        .view.active { display: flex; }

        input { 
            padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); 
            background: rgba(0,0,0,0.3); color: white; margin-bottom: 10px; font-size: 1rem;
        }

        .action-btn { 
            padding: 15px; border: none; border-radius: 10px; cursor: pointer; 
            font-weight: bold; color: white; background: var(--success); transition: 0.3s;
        }
        .action-btn:active { transform: scale(0.98); }

        #loading { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #1e293b; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <p style="margin-top: 20px; letter-spacing: 2px;">ƒêANG T·∫¢I H·ªÜ TH·ªêNG AI...</p>
</div>

<header><h2>Diem Danh AI Smart</h2></header>

<div id="webcam-wrapper">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
</div>

<div class="status-box">
    <div id="otp-box">
        <div style="color: var(--danger); font-size: 0.8rem; font-weight: bold; text-transform: uppercase;">X√°c th·ª±c Voice-Mouth Challenge</div>
        <div id="otp-number">000 000</div>
        <div class="progress-container"><div id="progress-bar"></div></div>
    </div>
    <div id="status-msg" style="font-weight: 500; color: rgba(255,255,255,0.7);">ƒêANG QU√âT SINH TR·∫ÆC H·ªåC...</div>
</div>

<div class="control-panel">
    <button id="btn-att" class="tab-btn active" onclick="switchTab('att')">ƒêI·ªÇM DANH</button>
    <button id="btn-reg" class="tab-btn" onclick="switchTab('reg')">C√ÄI ƒê·∫∂T</button>
</div>

<div id="view-att" class="view active">
    <button class="action-btn" style="background: var(--primary);" onclick="downloadCSV()">XU·∫§T D·ªÆ LI·ªÜU (EXCEL)</button>
</div>

<div id="view-reg" class="view">
    <input type="text" id="newName" placeholder="Nh·∫≠p t√™n h·ªçc sinh m·ªõi...">
    <button class="action-btn" onclick="registerFace()">ƒêƒÇNG K√ù M·∫™U M·∫∂T</button>
    <div id="list-items" style="margin-top: 15px; max-height: 120px; overflow-y: auto;"></div>
</div>

<script>
    const video = document.getElementById('video');
    const statusMsg = document.getElementById('status-msg');
    const otpBox = document.getElementById('otp-box');
    const otpNum = document.getElementById('otp-number');
    const progressBar = document.getElementById('progress-bar');
    
    let labeledFaceDescriptors = [];
    let attendanceLog = [["T√™n", "Ng√†y", "Gi·ªù"]];
    let isChallenging = false, mouthMoves = 0, challengePassed = false, currentMode = 'att';

    async function init() {
        const MODEL_URL = 'https://fastly.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        loadLocal();
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            document.getElementById('loading').style.display = 'none';
            runAI();
        };
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'vi-VN'; u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }

    async function runAI() {
        const canvas = document.getElementById('overlay');
        setInterval(async () => {
            if (currentMode !== 'att') {
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
            faceapi.matchDimensions(canvas, displaySize);

            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 256 }))
                .withFaceLandmarks().withFaceDescriptors();
            const resized = faceapi.resizeResults(detections, displaySize);
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

            if (resized.length > 0) {
                const det = resized[0];
                const mar = getMAR(det.landmarks.getMouth());

                if (!isChallenging && !challengePassed) {
                    isChallenging = true;
                    const otp = Math.floor(100000 + Math.random() * 900000);
                    otpNum.innerText = otp.toString().split('').join(' ');
                    otpBox.style.display = 'block';
                    speak("M·ªùi b·∫°n ƒë·ªçc d√£y s·ªë tr√™n m√†n h√¨nh");
                }

                if (isChallenging) {
                    // Ch·ªânh MAR > 0.12 ƒë·ªÉ nh·∫°y h∆°n v·ªõi m·ªçi ch·∫•t gi·ªçng/kh·∫©u h√¨nh
                    if (mar > 0.12) mouthMoves++;
                    let progress = (mouthMoves / 25) * 100;
                    progressBar.style.width = Math.min(progress, 100) + '%';

                    if (mouthMoves > 25) {
                        isChallenging = false; challengePassed = true;
                        otpBox.style.display = 'none';
                    }
                    new faceapi.draw.DrawBox(det.detection.box, { label: "ƒêANG X√ÅC TH·ª∞C MI·ªÜNG...", boxColor: "#ff7675" }).draw(canvas);
                } else if (challengePassed) {
                    const matcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5);
                    const best = matcher.findBestMatch(det.descriptor);
                    if (best.label !== 'unknown') {
                        statusMsg.innerHTML = `CH√ÄO M·ª™NG: <b style="color:var(--accent)">${best.label}</b>`;
                        record(best.label);
                    }
                    new faceapi.draw.DrawBox(det.detection.box, { label: "AN TO√ÄN", boxColor: "#00cec9" }).draw(canvas);
                }
            } else {
                // N·∫øu kh√¥ng th·∫•y m·∫∑t th√¨ reset ƒë·ªÉ ng∆∞·ªùi sau v√†o
                challengePassed = false; isChallenging = false; mouthMoves = 0;
                progressBar.style.width = '0%';
            }
        }, 150);
    }

    function getMAR(mouth) {
        const v = Math.sqrt(Math.pow(mouth[14].x - mouth[18].x, 2) + Math.pow(mouth[14].y - mouth[18].y, 2));
        const h = Math.sqrt(Math.pow(mouth[12].x - mouth[16].x, 2) + Math.pow(mouth[12].y - mouth[16].y, 2));
        return v / h;
    }

    async function registerFace() {
        const name = document.getElementById('newName').value;
        if (!name) return alert("Ch∆∞a nh·∫≠p t√™n!");
        const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        if (det) {
            labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [det.descriptor]));
            saveLocal(); render(); alert("ƒê√£ l∆∞u d·ªØ li·ªáu h·ªçc sinh!");
        }
    }

    function switchTab(mode) {
        currentMode = mode;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('view-' + mode).classList.add('active');
        document.getElementById('btn-' + mode).classList.add('active');
    }

    function record(name) {
        const d = new Date();
        const date = d.toLocaleDateString('vi-VN');
        if (!attendanceLog.some(r => r[0] === name && r[1] === date)) {
            attendanceLog.push([name, date, d.toLocaleTimeString('vi-VN')]);
            speak("X√°c th·ª±c th√†nh c√¥ng. Ch√†o b·∫°n " + name);
        }
    }

    function saveLocal() { localStorage.setItem('ai_db_v3', JSON.stringify(labeledFaceDescriptors.map(ld => ({ label: ld.label, descriptors: ld.descriptors.map(d => Array.from(d)) })))); }
    function loadLocal() {
        const data = localStorage.getItem('ai_db_v3');
        if (data) {
            const parsed = JSON.parse(data);
            labeledFaceDescriptors = parsed.map(d => new faceapi.LabeledFaceDescriptors(d.label, d.descriptors.map(a => new Float32Array(a))));
            render();
        }
    }
    function render() {
        document.getElementById('list-items').innerHTML = labeledFaceDescriptors.map(ld => `<div style="padding:10px; background:rgba(255,255,255,0.05); margin-bottom:5px; border-radius:8px;">üë§ ${ld.label}</div>`).join('');
    }
    function downloadCSV() {
        let csv = "\ufeff" + attendanceLog.map(r => r.join(",")).join("\n");
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
        a.download = 'BaoCao_AI.csv'; a.click();
    }

    init();
</script>
</body>
</html>
