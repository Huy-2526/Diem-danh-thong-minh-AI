<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ĐIỂM DANH - DỰ ÁN KHKT</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #0984e3; --accent: #00cec9; --bg: #0f172a; --success: #00b894; --warning: #f1c40f; --danger: #d63031; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; }
        
        /* Loading Screen */
        #loading { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--accent); }
        .loader { width: 60px; height: 60px; border: 4px solid #333; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; box-shadow: 0 0 15px var(--accent); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Header */
        header { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); width: 100%; padding: 20px 0; text-align: center; border-bottom: 1px solid #334155; }
        header h2 { margin: 0; letter-spacing: 2px; color: var(--accent); }

        /* Camera Frame */
        #webcam-wrapper { 
            position: relative; width: 90%; max-width: 640px; aspect-ratio: 4/3; 
            margin-top: 20px; border-radius: 20px; overflow: hidden; 
            border: 4px solid #334155; box-shadow: 0 0 50px rgba(0,0,0,0.5); 
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; }

        /* Scan Line & Challenge Box */
        .scan-line { position: absolute; width: 100%; height: 4px; background: var(--accent); top: 0; animation: move 3s linear infinite; box-shadow: 0 0 15px var(--accent); z-index: 5; }
        @keyframes move { 0% { top: 0; } 100% { top: 100%; } }
        
        .challenge-overlay {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 30px;
            border: 1px solid var(--warning); color: var(--warning); font-weight: bold; z-index: 10;
        }

        /* Controls */
        .panel { width: 90%; max-width: 640px; margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; color: white; }
        .btn-attendance { background: var(--primary); }
        .btn-manage { background: #334155; }
        .active-btn { border: 2px solid var(--accent); box-shadow: 0 0 10px var(--accent); }

        /* Status & Logs */
        .status-box { width: 90%; max-width: 640px; margin-top: 15px; padding: 15px; background: #1e293b; border-radius: 12px; text-align: center; border: 1px solid #334155; }
        #status-msg { color: var(--accent); font-size: 1.1rem; }

        .view { display: none; width: 100%; flex-direction: column; align-items: center; }
        .view.active { display: flex; }
        
        input { padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; width: 200px; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="loader"></div>
        <p>ĐANG KHỞI TẠO AI BẢO MẬT ĐA LỚP...</p>
    </div>

    <header>
        <h2>AI BIOMETRIC SYSTEM v4.0</h2>
        <p>Hệ thống chống giả mạo Deepfake - THCS Bình Thạnh</p>
    </header>

    <div id="webcam-wrapper">
        <video id="video" autoplay muted playsinline></video>
        <div class="scan-line"></div>
        <canvas id="overlay"></canvas>
        <div id="challenge-ui" class="challenge-overlay">CHỜ HỆ THỐNG SẴN SÀNG...</div>
    </div>

    <div class="status-box">
        <div id="status-msg">Vui lòng đứng trước Camera</div>
    </div>

    <div class="panel">
        <button id="tab1" class="btn btn-attendance active-btn" onclick="switchTab('att')">ĐIỂM DANH</button>
        <button id="tab2" class="btn btn-manage" onclick="switchTab('reg')">QUẢN LÝ DỮ LIỆU</button>
    </div>

    <div id="view-att" class="view active">
        <div class="panel" style="grid-template-columns: 1fr;">
            <button class="btn" style="background:var(--success)" onclick="downloadCSV()">XUẤT BÁO CÁO EXCEL</button>
        </div>
    </div>

    <div id="view-reg" class="view">
        <div class="panel" style="grid-template-columns: 1fr; background: #1e293b; padding: 20px; border-radius: 15px; margin-top: 15px;">
            <div style="display:flex; gap:10px; margin-bottom: 15px;">
                <input type="text" id="newName" placeholder="Tên học sinh...">
                <button class="btn btn-attendance" id="regBtn" onclick="registerFace()">CHỤP MẶT</button>
            </div>
            <div id="list-items" style="max-height: 150px; overflow-y: auto;"></div>
            <button class="btn btn-manage" onclick="exportJSON()" style="margin-top: 10px;">SAO LƯU DỮ LIỆU GỐC (.JSON)</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const statusMsg = document.getElementById('status-msg');
        const challengeUI = document.getElementById('challenge-ui');
        let labeledFaceDescriptors = [];
        let attendanceLog = [["Tên", "Ngày", "Giờ"]];
        
        // Cấu hình Thử thách
        let currentChallenge = "BLINK"; // BLINK, LEFT, RIGHT
        let hasBlinked = false;
        let hasTurned = false;
        let isProcessing = false;

        async function init() {
            const MODEL_URL = 'https://fastly.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            
            loadLocal();
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                document.getElementById('loading').style.display = 'none';
                startAI();
            };
        }

        function startAI() {
            const canvas = document.getElementById('overlay');
            const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 }))
                    .withFaceLandmarks().withFaceDescriptors();
                
                const resized = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                if (resized.length === 0) {
                    challengeUI.innerText = "HÃY ĐỨNG TRƯỚC CAMERA";
                    return;
                }

                resized.forEach(det => {
                    // 1. KIỂM TRA CHỚP MẮT (EAR)
                    const landmarks = det.landmarks;
                    const leftEye = landmarks.getLeftEye();
                    const rightEye = landmarks.getRightEye();
                    const ear = (getEAR(leftEye) + getEAR(rightEye)) / 2;
                    if (ear < 0.18) hasBlinked = true;

                    // 2. KIỂM TRA QUAY ĐẦU (Head Pose)
                    const nose = landmarks.getNose();
                    const jaw = landmarks.getJawOutline();
                    const noseX = nose[0].x;
                    const leftFace = jaw[0].x;
                    const rightFace = jaw[16].x;
                    
                    if (currentChallenge === "LEFT" && (noseX - leftFace) < (rightFace - noseX) * 0.7) hasTurned = true;
                    if (currentChallenge === "RIGHT" && (rightFace - noseX) < (noseX - leftFace) * 0.7) hasTurned = true;

                    // Hiển thị UI thử thách
                    if (!hasBlinked) {
                        challengeUI.innerText = "LỚP 1: MỜI BẠN CHỚP MẮT";
                        challengeUI.style.color = "var(--warning)";
                    } else if (!hasTurned) {
                        challengeUI.innerText = `LỚP 2: QUAY ĐẦU SANG ${currentChallenge === "LEFT" ? "TRÁI" : "PHẢI"}`;
                        challengeUI.style.color = "var(--warning)";
                    } else {
                        challengeUI.innerText = "ĐANG XÁC THỰC DANH TÍNH...";
                        challengeUI.style.color = "var(--success)";
                        
                        if (labeledFaceDescriptors.length > 0) {
                            const matcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5);
                            const best = matcher.findBestMatch(det.descriptor);
                            
                            if (best.label !== 'unknown') {
                                statusMsg.innerHTML = `CHÀO MỪNG: <b style="color:var(--success)">${best.label}</b>`;
                                record(best.label);
                                resetChallenge();
                            } else {
                                statusMsg.innerHTML = `<span style="color:var(--danger)">CẢNH BÁO: NGƯỜI LẠ</span>`;
                            }
                        }
                    }

                    // Vẽ khung
                    new faceapi.draw.DrawBox(det.detection.box, { 
                        label: hasTurned ? "Verified Person" : "Verifying...",
                        boxColor: hasTurned ? "#00b894" : "#f1c40f"
                    }).draw(canvas);
                });
            }, 200);
        }

        function getEAR(eye) {
            const v1 = Math.abs(eye[1].y - eye[5].y);
            const v2 = Math.abs(eye[2].y - eye[4].y);
            const h = Math.abs(eye[0].x - eye[3].x);
            return (v1 + v2) / (2 * h);
        }

        function resetChallenge() {
            setTimeout(() => {
                hasBlinked = false;
                hasTurned = false;
                currentChallenge = Math.random() > 0.5 ? "LEFT" : "RIGHT";
            }, 3000);
        }

        async function registerFace() {
            const name = document.getElementById('newName').value;
            if (!name) return alert("Nhập tên!");
            const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 }))
                .withFaceLandmarks().withFaceDescriptor();
            if (det) {
                labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [det.descriptor]));
                saveLocal(); render(); alert("Đã lưu!");
            }
        }

        function record(name) {
            const date = new Date().toLocaleDateString('vi-VN');
            const time = new Date().toLocaleTimeString('vi-VN');
            if (!attendanceLog.some(r => r[0] === name && r[1] === date)) {
                attendanceLog.push([name, date, time]);
            }
        }

        function saveLocal() {
            localStorage.setItem('khkt_tinh_v4', JSON.stringify(labeledFaceDescriptors.map(ld => ({ label: ld.label, descriptors: ld.descriptors.map(d => Array.from(d)) }))));
        }

        function loadLocal() {
            const data = localStorage.getItem('khkt_tinh_v4');
            if (data) {
                const parsed = JSON.parse(data);
                labeledFaceDescriptors = parsed.map(d => new faceapi.LabeledFaceDescriptors(d.label, d.descriptors.map(a => new Float32Array(a))));
                render();
            }
        }

        function render() {
            document.getElementById('list-items').innerHTML = labeledFaceDescriptors.map((ld, i) => `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; padding:5px; background:#0f172a; border-radius:5px">
                    <span>${ld.label}</span>
                    <button onclick="del(${i})" style="color:red; background:none; border:none; cursor:pointer">Xóa</button>
                </div>
            `).join('');
        }

        function del(i) { labeledFaceDescriptors.splice(i,1); saveLocal(); render(); }

        function switchTab(t) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + t).classList.add('active');
            document.getElementById('tab1').classList.toggle('active-btn', t==='att');
            document.getElementById('tab2').classList.toggle('active-btn', t==='reg');
        }

        function downloadCSV() {
            let csv = "\ufeff" + attendanceLog.map(r => r.join(",")).join("\n");
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            a.download = 'DiemDanh_AI.csv'; a.click();
        }

        function exportJSON() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([localStorage.getItem('khkt_tinh_v4')], {type:'application/json'}));
            a.download = 'DuLieu_Goc_AI.json'; a.click();
        }

        init();
    </script>
</body>
</html>

