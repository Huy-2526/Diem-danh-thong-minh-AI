<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>HỆ THỐNG ĐIỂM DANH THÔNG MINH AI</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #0984e3; --accent: #00cec9; --bg: #0f172a; --success: #00b894; --danger: #d63031; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; }
        #webcam-wrapper { position: relative; width: 640px; height: 480px; margin-top: 20px; border-radius: 15px; overflow: hidden; border: 3px solid #334155; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .status-box { width: 640px; margin-top: 15px; padding: 20px; background: #1e293b; border-radius: 10px; text-align: center; border: 1px solid #334155; }
        #otp-box { display: none; margin: 15px 0; }
        #otp-number { font-size: 3rem; color: var(--accent); letter-spacing: 15px; font-weight: 900; background: #0f172a; padding: 10px; border-radius: 10px; border: 2px dashed var(--accent); }
        .btn { padding: 10px 20px; border-radius: 5px; border: none; background: var(--primary); color: white; cursor: pointer; font-weight: bold; }
        #loading { position: fixed; inset: 0; background: #000; z-index: 99; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="loading"><h1>ĐANG TẢI MÔ HÌNH AI...</h1></div>

<header><h2>HỆ THỐNG ĐIỂM DANH THÔNG MINH AI</h2></header>

<div id="webcam-wrapper">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
</div>

<div class="status-box">
    <div id="status-msg">ĐANG QUÉT KHUÔN MẶT...</div>
    <div id="otp-box">
        <p style="color: var(--danger); font-weight: bold;">CẢNH BÁO BẢO MẬT: HÃY ĐỌC TO DÃY SỐ SAU</p>
        <div id="otp-number">000 000</div>
    </div>
    <button class="btn" onclick="location.reload()" style="margin-top: 10px;">LÀM MỚI HỆ THỐNG</button>
</div>

<script>
    const video = document.getElementById('video');
    const statusMsg = document.getElementById('status-msg');
    const otpBox = document.getElementById('otp-box');
    const otpNum = document.getElementById('otp-number');
    
    let labeledFaceDescriptors = [];
    let isChallenging = false; // Trạng thái đang bị nghi ngờ
    let mouthMoves = 0; // Đếm số lần mấp máy môi
    let challengePassed = false;

    async function init() {
        const MODEL_URL = 'https://fastly.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        loadLocal();
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            document.getElementById('loading').style.display = 'none';
            runAI();
        };
    }

    // Hàm phát âm thanh ra lệnh
    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'vi-VN';
        window.speechSynthesis.speak(u);
    }

    async function runAI() {
        const canvas = document.getElementById('overlay');
        const displaySize = { width: 640, height: 480 };
        faceapi.matchDimensions(canvas, displaySize);

        setInterval(async () => {
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 256 }))
                .withFaceLandmarks().withFaceDescriptors();
            const resized = faceapi.resizeResults(detections, displaySize);
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

            if (resized.length > 0) {
                const det = resized[0];
                const landmarks = det.landmarks;
                
                // 1. TÍNH TOÁN ĐỘ CỬ ĐỘNG CỦA MẮT VÀ MIỆNG
                const ear = (getEAR(landmarks.getLeftEye()) + getEAR(landmarks.getRightEye())) / 2;
                const mar = getMAR(landmarks.getMouth());

                // 2. LOGIC NGHI NGỜ (Nếu mặt quá tĩnh - như ảnh chụp)
                if (!isChallenging && !challengePassed) {
                    // Nếu sau 3 giây mà EAR không đổi (không chớp mắt) -> Kích hoạt đọc số
                    // Ở đây demo mình sẽ kích hoạt ngay nếu MAR < 0.1 (môi không động đậy)
                    triggerChallenge();
                }

                if (isChallenging) {
                    // Kiểm tra môi mấp máy khi đọc số
                    if (mar > 0.15) mouthMoves++; 

                    if (mouthMoves > 25) { // Đã đọc đủ lâu
                        isChallenging = false;
                        challengePassed = true;
                        otpBox.style.display = 'none';
                    }
                    new faceapi.draw.DrawBox(det.detection.box, { label: "ĐANG XÁC THỰC GIỌNG ĐỌC...", boxColor: "red" }).draw(canvas);
                } else {
                    // NHẬN DIỆN DANH TÍNH SAU KHI QUA THỬ THÁCH
                    const matcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5);
                    const best = matcher.findBestMatch(det.descriptor);
                    
                    statusMsg.innerHTML = `TRẠNG THÁI: <b style="color:var(--success)">AN TOÀN - ${best.label}</b>`;
                    new faceapi.draw.DrawBox(det.detection.box, { label: "ĐÃ XÁC THỰC", boxColor: "green" }).draw(canvas);
                    if(challengePassed && mouthMoves > 25) {
                        speak("Xác thực thành công. Chào bạn " + best.label);
                        mouthMoves = 0; // Reset
                    }
                }
            }
        }, 150);
    }

    function triggerChallenge() {
        if (isChallenging) return;
        isChallenging = true;
        const otp = Math.floor(100000 + Math.random() * 900000);
        otpNum.innerText = otp.toString().split('').join(' ');
        otpBox.style.display = 'block';
        statusMsg.innerText = "HỆ THỐNG NGHI NGỜ GIẢ MẠO!";
        speak("Hệ thống nghi ngờ giả mạo. Mời bạn đọc to dãy số trên màn hình để tiếp tục");
    }

    function getEAR(eye) {
        const p2_p6 = Math.sqrt(Math.pow(eye[1].x - eye[5].x, 2) + Math.pow(eye[1].y - eye[5].y, 2));
        const p3_p5 = Math.sqrt(Math.pow(eye[2].x - eye[4].x, 2) + Math.pow(eye[2].y - eye[4].y, 2));
        const p1_p4 = Math.sqrt(Math.pow(eye[0].x - eye[3].x, 2) + Math.pow(eye[0].y - eye[3].y, 2));
        return (p2_p6 + p3_p5) / (2.0 * p1_p4);
    }

    function getMAR(mouth) {
        const v = Math.sqrt(Math.pow(mouth[14].x - mouth[18].x, 2) + Math.pow(mouth[14].y - mouth[18].y, 2));
        const h = Math.sqrt(Math.pow(mouth[12].x - mouth[16].x, 2) + Math.pow(mouth[12].y - mouth[16].y, 2));
        return v / h;
    }

    function loadLocal() {
        const data = localStorage.getItem('khkt_data');
        if (data) {
            const parsed = JSON.parse(data);
            labeledFaceDescriptors = parsed.map(d => new faceapi.LabeledFaceDescriptors(d.label, d.descriptors.map(a => new Float32Array(a))));
        }
    }

    init();
</script>
</body>
</html>
