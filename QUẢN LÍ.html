<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Điểm Danh - THCS Bình Thạnh</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --navy: #0c2461; --blue: #1e90ff; --red: #ff3b30; }
        body { margin: 0; font-family: sans-serif; background: #f0f2f5; color: #333; }
        
        header { 
            background: white; padding: 15px 25px; 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 4px solid var(--navy); box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-title { font-size: 1.2rem; font-weight: 800; color: var(--navy); }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        
        .dashboard-summary { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; margin-bottom: 25px; 
        }
        .stat-card { 
            background: white; padding: 20px; border-radius: 12px; 
            text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-top: 4px solid var(--blue);
        }
        .stat-card h3 { margin: 0; font-size: 0.9rem; color: #666; text-transform: uppercase; }
        .stat-card div { font-size: 2rem; font-weight: 800; color: var(--navy); margin-top: 10px; }

        .btn-clear {
            background: var(--red); color: white; border: none; padding: 12px 20px;
            border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 20px;
            transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-clear:hover { opacity: 0.8; transform: scale(1.02); }

        .class-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
        }
        .class-card { 
            background: white; border-radius: 15px; padding: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: relative; transition: 0.3s; border-left: 5px solid var(--navy);
        }
        .class-card:hover { transform: translateY(-5px); }
        .class-name { font-size: 1.3rem; font-weight: 800; color: var(--navy); margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .class-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
        .class-info b { color: var(--navy); }
        .status-online { color: #2ecc71; font-weight: bold; font-size: 0.8rem; }
        
        .absent-tag { color: var(--red); font-weight: bold; }
        #clock { font-weight: bold; color: var(--navy); }
        .empty-state { text-align: center; grid-column: 1 / -1; padding: 50px; color: #999; }
    </style>
</head>
<body>

<header>
    <div class="header-title">TRUNG TÂM QUẢN LÝ ĐIỂM DANH</div>
    <div id="clock">00:00:00</div>
</header>

<div class="container">
    <div class="dashboard-summary">
        <div class="stat-card">
            <h3>Tổng số lớp Online</h3>
            <div id="total-classes">0</div>
        </div>
        <div class="stat-card" style="border-top-color: #2ecc71;">
            <h3>Tổng học sinh có mặt</h3>
            <div id="global-present">0</div>
        </div>
        <div class="stat-card" style="border-top-color: var(--red);">
            <h3>Tổng học sinh vắng</h3>
            <div id="global-absent">0</div>
        </div>
    </div>

    <button class="btn-clear" onclick="clearGhostDevices()">DỌN DẸP MÁY MA (LÀM MỚI DANH SÁCH)</button>

    <h2 style="color: var(--navy); margin-bottom: 20px;">Trạng thái chi tiết các lớp:</h2>
    <div id="class-grid" class="class-grid">
        <div class="empty-state">Đang chờ các máy quét kết nối...</div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCRlm5nRrp3DTXV-XJITup3xEHAc5re7oU",
        databaseURL: "https://diemdanhthcsbt-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "diemdanhthcsbt",
    };
    
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // 1. TỐI ƯU KẾT NỐI
    const adminRef = db.ref('admin_status/QUAN_LY_CHINH');
    db.ref('.info/connected').on('value', (snap) => {
        if (snap.val() === true) {
            adminRef.onDisconnect().remove();
            adminRef.set({ status: "online", lastSeen: new Date().toLocaleTimeString() });
        }
    });

    // 2. LẮNG NGHE DỮ LIỆU THẦN TỐC
    db.ref('diemdaily_status').on('value', (snapshot) => {
        const data = snapshot.val();
        const grid = document.getElementById('class-grid');
        
        if (!data) {
            grid.innerHTML = '<div class="empty-state">Hiện không có lớp nào Online bạn ơi!</div>';
            updateSummary(0, 0, 0);
            return;
        }

        const fragment = document.createDocumentFragment();
        let totalPresent = 0, totalAbsent = 0, classCount = 0;

        const sortedKeys = Object.keys(data).sort();

        sortedKeys.forEach(key => {
            const classInfo = data[key];
            if (!classInfo.name) return;

            classCount++;
            totalPresent += parseInt(classInfo.presentStudents || 0);
            totalAbsent += parseInt(classInfo.absentStudents || 0);

            const card = document.createElement('div');
            card.className = 'class-card';
            card.innerHTML = `
                <div class="class-name">Lớp: ${classInfo.name}</div>
                <div class="class-info">Sĩ số: <b>${classInfo.totalStudents}</b></div>
                <div class="class-info">Có mặt: <b style="color:#2ecc71">${classInfo.presentStudents}</b></div>
                <div class="class-info">Vắng: <b class="absent-tag">${classInfo.absentStudents}</b></div>
                <div style="margin-top:15px; font-size:0.75rem; color:#999; display:flex; justify-content:space-between;">
                    <span>Cập nhật: ${classInfo.lastSeen}</span>
                    <span class="status-online">● ONLINE</span>
                </div>
            `;
            fragment.appendChild(card);
        });

        grid.innerHTML = '';
        grid.appendChild(fragment);
        updateSummary(classCount, totalPresent, totalAbsent);
    });

    function updateSummary(count, present, absent) {
        document.getElementById('total-classes').innerText = count;
        document.getElementById('global-present').innerText = present;
        document.getElementById('global-absent').innerText = absent;
    }

    // 3. HÀM DỌN DẸP
    async function clearGhostDevices() {
        if(confirm("Bạn ơi, xác nhận dọn dẹp danh sách lớp để tăng tốc độ nhé?")) {
            await db.ref('diemdaily_status').set(null); 
            // Sau khi xóa, Firebase sẽ tự cập nhật giao diện ngay lập tức nhờ hàm .on('value')
        }
    }

    setInterval(() => {
        const clockElem = document.getElementById('clock');
        if(clockElem) clockElem.innerText = new Date().toLocaleTimeString('vi-VN');
    }, 1000);
</script>

</body>
</html>
