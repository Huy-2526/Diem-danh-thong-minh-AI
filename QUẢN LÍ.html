<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω ƒêi·ªÉm Danh - THCS B√¨nh Th·∫°nh</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --navy: #0c2461; --blue: #1e90ff; --green: #28a745; --light: #f4f7f6; }
        body { font-family: -apple-system, sans-serif; background: var(--light); margin: 0; padding: 20px; }
        
        .admin-container { max-width: 1000px; margin: 0 auto; }
        header { background: white; padding: 15px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; border-left: 6px solid var(--navy); }
        h1 { color: var(--navy); margin: 0; font-size: 1.4rem; }

        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }

        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card-title { font-weight: 800; color: var(--navy); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* Style cho danh s√°ch m√°y qu√©t */
        .device-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            background: #f8fbff; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            border: 1px solid #e1e8f0;
            transition: 0.3s;
        }
        .device-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .class-name { font-weight: bold; color: var(--navy); font-size: 1.1rem; }
        .update-time { font-size: 0.75rem; color: #888; }
        
        .stats-badge { 
            background: white; 
            padding: 5px 15px; 
            border-radius: 20px; 
            border: 2px solid var(--green);
            text-align: center;
        }
        .present-count { color: var(--green); font-weight: 800; font-size: 1.2rem; }
        .total-count { color: #666; font-size: 0.9rem; }

        /* Nh·∫≠t k√Ω ƒëi·ªÉm danh nhanh */
        .log-item { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; display: flex; justify-content: space-between; }
        .status-online { display: inline-block; width: 10px; height: 10px; background: var(--green); border-radius: 50%; margin-right: 5px; }
    </style>
</head>
<body>

<div class="admin-container">
    <header>
        <div>
            <h1>H·ªÜ TH·ªêNG QU·∫¢N L√ù T·∫¨P TRUNG</h1>
            <small>Tr∆∞·ªùng THCS B√¨nh Th·∫°nh</small>
        </div>
        <div id="live-clock" style="font-weight: bold; color: var(--blue);">00:00:00</div>
    </header>

    <div class="grid-layout">
        <div class="card">
            <div class="card-title">
                <span>üì∫ M√ÅY QU√âT C√ÅC L·ªöP</span>
                <span id="device-count" style="font-size: 0.8rem; background: var(--navy); color: white; padding: 2px 8px; border-radius: 10px;">0 Online</span>
            </div>
            <div id="status-list">
                <p style="text-align:center; color:#999;">ƒêang t√¨m thi·∫øt b·ªã...</p>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üöÄ HO·∫†T ƒê·ªòNG V·ª™A XONG</div>
            <div id="recent-logs">
                <p style="text-align:center; color:#999;">Ch∆∞a c√≥ d·ªØ li·ªáu m·ªõi...</p>
            </div>
            <button onclick="location.reload()" style="width:100%; margin-top:15px; padding:10px; cursor:pointer; border-radius:8px; border:1px solid #ddd; background:#fff;">L√ÄM M·ªöI D·ªÆ LI·ªÜU</button>
        </div>
    </div>
</div>

<script>
    // C·∫§U H√åNH FIREBASE (Gi·ªØ nguy√™n c·ªßa Huy)
    const firebaseConfig = {
        apiKey: "AIzaSyCRlm5nRrp3DTXV-XJITup3xEHAc5re7oU",
        databaseURL: "https://diemdanhthcsbt-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "diemdanhthcsbt",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 1. L·∫ÆNG NGHE TR·∫†NG TH√ÅI V√Ä Sƒ® S·ªê T·ª™NG M√ÅY
    db.ref('DiemDanh_Status').on('value', snapshot => {
        const statusList = document.getElementById('status-list');
        const deviceCount = document.getElementById('device-count');
        statusList.innerHTML = '';
        const data = snapshot.val();
        
        if (data) {
            const devices = Object.values(data);
            deviceCount.innerText = devices.length + " Online";
            
            devices.forEach(device => {
                const item = document.createElement('div');
                item.className = 'device-item';
                
                // T√≠nh ph·∫ßn trƒÉm ƒë·ªÉ n·∫øu Huy mu·ªën l√†m thanh progress sau n√†y
                const percent = device.totalStudents > 0 ? Math.round((device.presentStudents / device.totalStudents) * 100) : 0;

                item.innerHTML = `
                    <div>
                        <div class="class-name"><span class="status-online"></span>${device.name}</div>
                        <div class="update-time">C·∫≠p nh·∫≠t: ${device.lastSeen}</div>
                    </div>
                    <div class="stats-badge">
                        <span class="present-count">${device.presentStudents || 0}</span>
                        <span class="total-count">/${device.totalStudents || 0}</span>
                        <div style="font-size: 0.6rem; color: var(--green); font-weight: bold;">${percent}%</div>
                    </div>
                `;
                statusList.appendChild(item);
            });
        } else {
            deviceCount.innerText = "0 Online";
            statusList.innerHTML = '<p style="text-align:center; color:#999; padding: 20px;">Hi·ªán kh√¥ng c√≥ m√°y l·ªõp n√†o ƒëang m·ªü.</p>';
        }
    });

    // 2. HI·ªÇN TH·ªä ƒê·ªíNG H·ªí
    setInterval(() => {
        document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('vi-VN');
    }, 1000);

    // 3. (T√ôY CH·ªåN) HI·ªÇN TH·ªä D·ªÆ LI·ªÜU M·ªöI NH·∫§T TR√äN FIREBASE ƒê·ªÇ THEO D√ïI
    // N·∫øu Huy mu·ªën hi·ªán log chung c·ªßa t·∫•t c·∫£ c√°c m√°y ƒë·ªï v·ªÅ ƒë√¢y
    db.ref('Remote_View').on('value', snapshot => {
        const logDiv = document.getElementById('recent-logs');
        const data = snapshot.val();
        if (data) {
            logDiv.innerHTML = `
                <div class="log-item" style="background: #fff8e1; padding: 10px; border-radius: 8px; border: 1px solid #ffe082;">
                    <span><b>${data.class}:</b> ${data.last_user}</span>
                    <span style="color: #666;">${data.time}</span>
                </div>
            ` + logDiv.innerHTML;
        }
    });

</script>
</body>
</html>
