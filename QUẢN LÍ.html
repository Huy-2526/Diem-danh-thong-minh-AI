<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Điểm Danh - THCS Bình Thạnh</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@300..700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { 
            --navy: #0c2461; 
            --blue: #1e90ff; 
            --red: #ff3b30; 
            --green: #2ecc71;
        }

        body { 
            margin: 0; 
            font-family: "Quicksand", sans-serif; 
            background: #f0f2f5; 
            color: #333; 
        }
        
        header { 
            background: white; 
            padding: 15px 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 4px solid var(--navy); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-title { 
            font-family: "Pacifico", cursive;
            font-size: 1.8rem; 
            color: var(--navy); 
        }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        
        /* Dashboard tổng quát */
        .dashboard-summary { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            text-align: center; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-top: 5px solid var(--blue);
        }
        .stat-card h3 { margin: 0; font-size: 0.85rem; color: #666; text-transform: uppercase; font-weight: 700; }
        .stat-card div { font-size: 2.2rem; font-weight: 800; color: var(--navy); margin-top: 10px; }

        .btn-clear {
            font-family: "Quicksand", sans-serif;
            background: var(--red); 
            color: white; 
            border: none; 
            padding: 14px 25px;
            border-radius: 10px; 
            font-weight: 700; 
            cursor: pointer; 
            margin-bottom: 25px;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);
            width: 100%;
            max-width: 350px;
        }
        .btn-clear:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-clear:disabled { background: #ccc; cursor: not-allowed; }

        /* Danh sách các lớp */
        .class-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
        }
        .class-card { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 6px solid var(--navy);
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .class-name { 
            font-size: 1.4rem; 
            font-weight: 800; 
            color: var(--navy); 
            margin-bottom: 15px; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 10px; 
        }
        
        .class-info { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1rem; }
        .class-info b { color: var(--navy); font-weight: 700; }
        
        /* CSS cho danh sách tên vắng */
        .absent-list-container {
            margin-top: 10px;
            padding: 10px;
            background: #fff5f5;
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--red);
            border: 1px dashed var(--red);
        }
        .absent-title { font-weight: 800; margin-bottom: 5px; text-transform: uppercase; font-size: 0.75rem; }
        .absent-names { line-height: 1.4; }

        .status-online { color: var(--green); font-weight: 800; font-size: 0.8rem; letter-spacing: 1px; }
        .absent-tag { color: var(--red); font-weight: 800; }
        #clock { font-weight: 700; color: var(--navy); font-size: 1.1rem; }
        .empty-state { text-align: center; grid-column: 1 / -1; padding: 60px; color: #999; font-weight: 600; }
    </style>
</head>
<body>

<header>
    <div class="header-title">Quản lý Điểm danh</div>
    <div id="clock">00:00:00</div>
</header>

<div class="container">
    <div class="dashboard-summary">
        <div class="stat-card">
            <h3>Lớp Đang Online</h3>
            <div id="total-classes">0</div>
        </div>
        <div class="stat-card" style="border-top-color: var(--green);">
            <h3>Học Sinh Có Mặt</h3>
            <div id="global-present">0</div>
        </div>
        <div class="stat-card" style="border-top-color: var(--red);">
            <h3>Học Sinh Vắng</h3>
            <div id="global-absent">0</div>
        </div>
    </div>

    <center>
        <button id="btnDọn" class="btn-clear" onclick="clearGhostDevices()">DỌN DẸP MÁY MA (RESET DANH SÁCH)</button>
    </center>

    <h2 style="color: var(--navy); margin: 30px 0 20px 0; font-weight: 800;">Trạng thái chi tiết:</h2>
    <div id="class-grid" class="class-grid">
        <div class="empty-state">Bạn ơi, đang đợi máy quét kết nối nhé...</div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCRlm5nRrp3DTXV-XJITup3xEHAc5re7oU",
        databaseURL: "https://diemdanhthcsbt-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "diemdanhthcsbt",
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    db.ref('diemdaily_status').on('value', (snapshot) => {
        const data = snapshot.val();
        const grid = document.getElementById('class-grid');
        
        if (!data) {
            grid.innerHTML = '<div class="empty-state">Hiện không có lớp nào Online bạn ơi!</div>';
            updateSummary(0, 0, 0);
            return;
        }

        let totalPresent = 0, totalAbsent = 0, classCount = 0;
        let htmlContent = '';

        const sortedKeys = Object.keys(data).sort();

        sortedKeys.forEach(key => {
            const classInfo = data[key];
            if (!classInfo.name) return;

            classCount++;
            totalPresent += parseInt(classInfo.presentStudents || 0);
            totalAbsent += parseInt(classInfo.absentStudents || 0);

            // Lấy danh sách tên vắng (nếu có)
            const vắngNames = classInfo.absentList || "Đang cập nhật...";

            htmlContent += `
                <div class="class-card">
                    <div class="class-name">Lớp: ${classInfo.name}</div>
                    <div class="class-info">Sĩ số: <b>${classInfo.totalStudents}</b></div>
                    <div class="class-info">Có mặt: <b style="color:var(--green)">${classInfo.presentStudents}</b></div>
                    <div class="class-info">Vắng: <b class="absent-tag">${classInfo.absentStudents}</b></div>
                    
                    <div class="absent-list-container">
                        <div class="absent-title">Danh sách vắng:</div>
                        <div class="absent-names">${vắngNames}</div>
                    </div>

                    <div style="margin-top:15px; font-size:0.75rem; color:#999; display:flex; justify-content:space-between; align-items:center;">
                        <span>Cập nhật: ${classInfo.lastSeen}</span>
                        <span class="status-online">● ONLINE</span>
                    </div>
                </div>`;
        });

        grid.innerHTML = htmlContent;
        updateSummary(classCount, totalPresent, totalAbsent);
    });

    function updateSummary(count, present, absent) {
        document.getElementById('total-classes').innerText = count;
        document.getElementById('global-present').innerText = present;
        document.getElementById('global-absent').innerText = absent;
    }

    async function clearGhostDevices() {
        const btn = document.getElementById('btnDọn');
        if(!confirm("Bạn ơi, bạn có chắc muốn dọn dẹp danh sách để tăng tốc độ không?")) return;

        btn.innerText = "ĐANG DỌN DẸP...";
        btn.disabled = true;

        try {
            await db.ref('diemdaily_status').set(null);
            btn.innerText = "ĐÃ XONG!";
            btn.style.background = "var(--green)";
            
            setTimeout(() => {
                btn.innerText = "DỌN DẸP MÁY MA (RESET DANH SÁCH)";
                btn.style.background = "var(--red)";
                btn.disabled = false;
            }, 1500);
        } catch (e) {
            alert("Lỗi kết nối Firebase bạn ơi!");
            btn.disabled = false;
        }
    }

    setInterval(() => {
        const clockElem = document.getElementById('clock');
        if(clockElem) clockElem.innerText = new Date().toLocaleTimeString('vi-VN');
    }, 1000);
</script>

</body>
</html>
